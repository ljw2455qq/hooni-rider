<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Tracker (핸드폰)</title>
</head>
<body>
  <h1>GPS 이동 거리 추적</h1>
  <p>총 이동량: <span id="distance">0.00 km</span></p>
  <p id="status">GPS 대기 중...</p>
  <button onclick="startTracking()">시작</button>

  <script type="module">
    import { db } from './firebase.js';
    import { ref, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    let totalDistance = 0;
    let previousPosition = null;

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // 지구 반경 (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateDistance(position) {
      const currentPosition = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
      };

      if (previousPosition) {
        const distance = calculateDistance(
          previousPosition.latitude,
          previousPosition.longitude,
          currentPosition.latitude,
          currentPosition.longitude
        );
        totalDistance += distance;
      }

      previousPosition = currentPosition;
      document.getElementById('distance').textContent = totalDistance.toFixed(2) + ' km';
      document.getElementById('status').innerText = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;

      // Firebase에 업로드
      set(ref(db, 'gps'), {
        distance: totalDistance.toFixed(2),
        latitude: currentPosition.latitude,
        longitude: currentPosition.longitude,
        timestamp: Date.now()
      });
    }

    function handleError(error) {
      document.getElementById('status').innerText = `오류: ${error.message}`;
    }

    function startTracking() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(updateDistance, handleError, {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        });
      } else {
        document.getElementById('status').innerText = "GPS 지원 안 됨";
      }
    }
  </script>
</body>
</html>
